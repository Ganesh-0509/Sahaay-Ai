{% extends "_layout.html" %}

{% block title %}{{ lang.dashboard_home }}{% endblock %}

{% block content %}
<header class="flex justify-between items-center mb-8">
    <div class="flex items-center gap-4">
        <button id="menuBtn" class="text-gray-800 dark:text-gray-100 text-2xl font-bold md:hidden">â˜°</button>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">{{ lang.dashboard_home }}</h1>
    </div>
    <div class="flex items-center gap-4">
        <div class="relative inline-block text-left">
            <select id="filterSelect" class="bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-sm px-4 py-2 text-sm font-medium">
                <option value="last10">Last 10 Entries</option>
                <option value="last7days">Last 7 Days</option>
                <option value="all">All Time</option>
            </select>
        </div>
        <a href="{{ url_for('chat_page') }}" class="px-5 py-2 bg-teal-600 text-white rounded-lg shadow-md hover:bg-teal-500 rounded-lg shadow-md hover:bg-teal-500 text-white">{{ lang.daily_checkin_btn }}</a>
    </div>
</header>

<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
    <div class="card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold mb-3">{{ lang.mood_snapshot }}</h3>
        <p id="moodSnapshot" class="text-gray-600 dark:text-gray-300">{{ lang.loading }}</p>
    </div>
    <div class="card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold mb-3">{{ lang.streak_tracker }}</h3>
        <p id="streakTracker" class="text-gray-600 dark:text-gray-300">{{ lang.loading }}</p>
    </div>
    <div class="card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold mb-3">{{ lang.quote_of_the_day }}</h3>
        <p id="dailyQuote" class="text-gray-600 dark:text-gray-300">{{ lang.loading }}</p>
    </div>
    <div class="card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2">
        <h3 class="text-xl font-semibold mb-3">{{ lang.recent_checkins }}</h3>
        <ul id="recentCheckins" class="list-disc pl-5 max-h-64 overflow-y-auto">
            <li>{{ lang.loading }}</li>
        </ul>
    </div>
    <div class="card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2">
        <h3 class="text-xl font-semibold mb-3">{{ lang.helpful_tips }}</h3>
        <ul id="helpfulTipsList" class="list-disc pl-5 max-h-64 overflow-y-auto">
            <li>{{ lang.loading }}</li>
        </ul>
    </div>
</section>
{% endblock %}

{% block page_scripts %}
<script>
    const filterSelect = document.getElementById('filterSelect');
    filterSelect.addEventListener('change', fetchHomeData);

    async function fetchHomeData() {
        const period = filterSelect.value;
        try {
            const res = await fetch(`/api/home_data?period=${period}`);
            const data = await res.json();
            
            document.getElementById('moodSnapshot').textContent = data.mood || "No data yet.";
            document.getElementById('streakTracker').textContent = data.streak ? data.streak + " days" : "0 days";
            document.getElementById('dailyQuote').textContent = data.quote || "Stay positive!";

            const helpfulUl = document.getElementById('helpfulTipsList');
            helpfulUl.innerHTML = '';
            if (data.helpful && data.helpful.length > 0) {
                data.helpful.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.date || ''} - ${item.mood}: ${item.tip}`;
                    helpfulUl.appendChild(li);
                });
            } else {
                helpfulUl.innerHTML = '<li>No helpful tips saved yet.</li>';
            }

            const recentUl = document.getElementById('recentCheckins');
            recentUl.innerHTML = '';
            if (data.recent && data.recent.length) {
                data.recent.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.date} - ${item.mood}`;
                    recentUl.appendChild(li);
                });
            } else {
                recentUl.innerHTML = '<li>No recent check-ins.</li>';
            }
        } catch(err){ console.error("Error fetching home data:", err); }
    }

    fetchHomeData();
</script>
{% endblock %}