{% extends "_layout.html" %}

{% block title %}{{ lang.mood_journal }}{% endblock %}

{% block content %}
<header class="mb-8">
  <div class="flex items-center gap-4">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">{{ lang.mood_journal }}</h1>
  </div>
  <p class="mt-2 text-gray-600 dark:text-gray-400">Weekly emotional summary, recurring themes & analytics.</p>
</header>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Left column cards -->
  <div class="lg:col-span-2 space-y-6">

    <!-- Animated header + summary -->
    <div class="card">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">ğŸ—“ Weekly Emotional Summary</h3>
          <p id="weeklySummary" class="mt-2 text-gray-700 dark:text-gray-300">Loading summaryâ€¦</p>
        </div>
        <div>
          <button id="refreshSummary" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Previous Day Summarizer Card -->
    <div class="card">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">ğŸ“ Previous Day Summary</h3>
          <p id="prevDaySummary" class="mt-2 text-gray-700 dark:text-gray-300">Loading summaryâ€¦</p>
        </div>
        <div>
          <button id="refreshPrevDaySummary" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Refresh</button>
        </div>
      </div>
    </div>

    

    <!-- Themes -->
    <div class="card">
      <h4 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">ğŸ’¬ Recurring Themes</h4>
      <ul id="themeList" class="list-disc pl-5 text-gray-700 dark:text-gray-300"></ul>
      <button id="loadAItopics" class="mt-3 px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Generate AI Themes</button>
    </div>

  </div>

  <!-- Right column: Highlights only -->
  <aside class="space-y-6">
    <div class="card">
      <h4 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">âœ¨ Highlights</h4>
      <p class="text-gray-700 dark:text-gray-300"><strong>Best day:</strong> <span id="bestDay">â€”</span></p>
      <p class="mt-2 text-gray-700 dark:text-gray-300"><strong>Toughest day:</strong> <span id="worstDay">â€”</span></p>
    </div>
  </aside>

</div>

{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function fetchInsights() {
  // Fetch previous day summary
  async function loadPrevDaySummary(force=false) {
    const summaryElem = document.getElementById('prevDaySummary');
    summaryElem.textContent = 'Loading summaryâ€¦';
    try {
      const res = await fetch('/api/previous_day_summary');
      const j = await res.json();
      if(j.ok && j.summary) {
        summaryElem.textContent = j.summary;
      } else {
        summaryElem.textContent = 'Could not generate summary.';
      }
    } catch (e) {
      summaryElem.textContent = 'Error loading summary.';
    }
  }
  document.getElementById('refreshPrevDaySummary').addEventListener('click', ()=> loadPrevDaySummary(true));
  loadPrevDaySummary();
  try {
    const res = await fetch('/api/mood_insights?days=30');
    const data = await res.json();
    if(!data.ok) return console.error('No insights');

    // ...sentiment trend chart removed...

    // Themes
    const themeList = document.getElementById('themeList');
    themeList.innerHTML = '';
    const tRes = await fetch('/api/mood_themes?days=30');
    const tData = await tRes.json();
    if(tData.ok){
      (tData.themes || []).slice(0,8).forEach(t=>{
        const li = document.createElement('li');
        li.textContent = t.keyword + (t.associated_mood ? ' â€” ' + t.associated_mood : '');
        themeList.appendChild(li);
      });
    }

    // Best/Worst day
    document.getElementById('bestDay').textContent = data.best_day ? (data.best_day.date + ' ('+data.best_day.sentiment+')') : 'â€”';
    document.getElementById('worstDay').textContent = data.worst_day ? (data.worst_day.date + ' ('+data.worst_day.sentiment+')') : 'â€”';

  } catch (e) {
    console.error(e);
  }
}

async function loadWeeklySummary(force=false) {
  try {
    const res = await fetch('/api/mood_weekly_summary' + (force? '?force=true':''));
    const j = await res.json();
    if(j.ok){
      document.getElementById('weeklySummary').textContent = j.summary;
    } else {
      document.getElementById('weeklySummary').textContent = 'Could not generate summary.';
    }
  } catch(e){
    console.error(e);
  }
}

document.getElementById('refreshSummary').addEventListener('click', ()=> loadWeeklySummary(true));
document.getElementById('loadAItopics').addEventListener('click', async ()=>{
  const res = await fetch('/api/mood_themes?ai=true');
  const j = await res.json();
  const themeList = document.getElementById('themeList');
  if(j.ok && j.themes_ai && j.themes_ai.length){
    j.themes_ai.slice(0,6).forEach(t=>{
      const li = document.createElement('li');
      li.textContent = t;
      themeList.appendChild(li);
    });
  } else {
    alert('AI themes not available right now.');
  }
});

// initial load
fetchInsights();
loadWeeklySummary();
</script>
{%Â endblockÂ %}
